<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donation Page</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .circle-container {
      position: relative;
      width: 200px;
      height: 200px;
    }
    .circle-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-900 text-white p-4">
  <header class="bg-gray-800 p-4 rounded shadow text-center mb-6">
    <h1 class="text-2xl font-bold">Help Me Kickstart My Streaming Dream! ðŸŽ®ðŸŽ¥</h1>
    <p class="text-sm text-gray-300 mt-4">
      Hi there! My name is Opeyemi Tolulope... <br><br>
      Donate now and be a part of my story ðŸ’™
    </p>
  </header>

  <div class="max-w-3xl mx-auto">
    <!-- Donation Progress Circle -->
    <div class="circle-container mx-auto my-6">
      <canvas id="donationChart"></canvas>
      <div class="circle-center" id="donationTarget">â‚¦0</div>
    </div>

    <!-- Donation Form -->
    <div class="bg-gray-800 p-4 rounded shadow">
      <form id="registration-form" onsubmit="submitForm(event)">
        <h2 class="text-lg font-semibold mb-2">Make a Donation</h2>
        <input type="email" name="email" id="email" placeholder="Enter your email" class="border p-2 w-full mb-2 text-black" required>
        <input type="number" name="amount" id="amount" placeholder="Enter amount in Naira" class="border p-2 w-full mb-2 text-black" required>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Donate</button>
      </form>
    </div>

    <!-- Donation History -->
    <div class="bg-gray-800 p-4 mt-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Donation History</h2>
      <ul id="donationHistory" class="text-sm text-gray-300"></ul>
    </div>

    <!-- Items to Purchase -->
    <div class="bg-gray-800 p-4 mt-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Items to Purchase</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="text-center">
          <img src="./images/redmi.jpg" class="w-full rounded">
          <p class="mt-1 text-white">Redmi Pad SE</p>
          <p class="mt-1 text-white">â‚¦250,000</p>
        </div>
        <div class="text-center">
          <img src="./images/qusa.jpg" class="w-full rounded">
          <p class="mt-1 text-white">Inverter</p>
          <p class="mt-1 text-white">â‚¦260,000</p>
        </div>
        <div class="text-center">
          <img src="./images/webcam.jpg" class="w-full rounded">
          <p class="mt-1 text-white">Logitech webcam</p>
          <p class="mt-1 text-white">â‚¦25,000</p>
        </div>
        <div class="text-center">
          <img src="./images/light.jpg" class="w-full rounded">
          <p class="mt-1 text-white">Streaming light</p>
          <p class="mt-1 text-white">â‚¦30,000</p>
        </div>
      </div>
    </div>

    <!-- Social Media -->
    <div class="bg-gray-800 p-4 mt-6 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Follow to Support</h2>
      <div class="space-y-2">
        <div>YOUTUBE: <a href="https://www.youtube.com/@ToluStreamsItAll" class="text-pink-400 hover:underline">@ToluStreamsItAll</a></div>
        <div>TWITTER/X: <a href="https://x.com/OpeyemiTolu25" class="text-pink-400 hover:underline">@OpeyemiTolu25</a></div>
      </div>
    </div>
  </div>

  <!-- JS Section -->
 <script>
  const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGO0K0RXNJpqKt7m58eh-fBt6LsUMnKh23QKILAeU7o7ichzF0TZ5XqbtnXet3Ry3hmh3BTGDGB9ya/pub?output=csv";
  const goalAmount = 700000;
  const donationText = document.getElementById("donationCenterText");
  const historyList = document.getElementById("donationHistory");

  const ctx = document.getElementById("donationChart").getContext("2d");
  const chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Donated", "Remaining"],
      datasets: [{
        data: [0, goalAmount],
        backgroundColor: ["#10B981", "#374151"],
        borderWidth: 1
      }]
    },
    options: {
      cutout: "70%",
      plugins: {
        legend: { display: false }
      }
    }
  });

  async function fetchDonations() {
    try {
      const res = await fetch(sheetURL);
      const csv = await res.text();
      const rows = csv.trim().split("\n");
      const headers = rows[0].split(",");
      const emailIndex = headers.indexOf("Email");
      const amountIndex = headers.indexOf("Amount");

      if (emailIndex === -1 || amountIndex === -1) {
        console.error("CSV headers missing required columns.");
        return;
      }

      const donations = rows.slice(1).map(row => {
        const cols = row.split(",");
        return {
          email: cols[emailIndex],
          amount: parseInt(cols[amountIndex])
        };
      });

      const total = donations.reduce((sum, d) => sum + (isNaN(d.amount) ? 0 : d.amount), 0);

      // Update chart
      chart.data.datasets[0].data = [total, Math.max(goalAmount - total, 0)];
      chart.update();

      // Update center text
      donationText.innerText = `â‚¦${total.toLocaleString()}`;

      // Update history
      historyList.innerHTML = "";
      donations.slice(-10).reverse().forEach(d => {
        const li = document.createElement("li");
        li.textContent = `${d.email} donated â‚¦${d.amount}`;
        historyList.appendChild(li);
      });
    } catch (error) {
      console.error("Failed to fetch donation data:", error);
    }
  }

  // NO automatic updates:
  // setInterval(fetchDonations, 10000);

  // Just fetch once immediately:
  fetchDonations();
</script>

</body>
</html>
